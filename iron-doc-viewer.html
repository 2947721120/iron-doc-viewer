<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../hydrolysis/hydrolysis-analyzer.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../prism-highlighter/prism-highlighter.html">

<link rel="import" href="iron-doc-element.html">

<!--
Renders documentation for all Polymer elements declared via an import.

Point it at an import that declares (or transitively imports) all the elments
you want to document:

    <iron-doc-viewer src="my-elements.html"></iron-doc-viewer>

-->
<dom-module id="iron-doc-viewer">

  <link rel="import" type="css" href="iron-doc-viewer.css">

  <template>
    <prism-highlighter></prism-highlighter>
    <hydrolysis-analyzer src="[[src]]" transitive="[[transitive]]" clean analyzer="{{_analyzer}}" loading="{{_loading}}"></hydrolysis-analyzer>

    <iron-doc-element id="page" descriptor="[[_activeElement]]"></iron-doc-element>
    <nav>
      <ul on-tap="_onTapNavItem">
        <!-- Polymer features are crazy special cased as `Polymer.Base`. -->
        <template is="x-repeat" items="[[_elements]]">
          <li abstract$="[[item.abstract]]">[[item.is]]</li>
        </template>
      </ul>
    </nav>
  </template>

</dom-module>

<script>
(function() {
var hydrolysis = require('hydrolysis');

  Polymer({

    is: 'iron-doc-viewer',

    enableCustomStyleProperties: true,

    properties: {

      /**
       * The URL to an import that declares (or transitively imports) the
       * elements that you wish to see documented.
       *
       * If the URL is relative, it will be resolved relative to the master
       * document.
       *
       * If you change this value after the `<iron-doc-viewer>` has been
       * instantiated, you must call `load()`.
       */
      src: String,

      /**
       * Whether _all_ dependencies should be loaded and documented.
       *
       * Turning this on will probably slow down the load process dramatically.
       */
      transitive: Boolean,

      /** The Hydrolysis element descripotrs being rendered. */
      _elements: {
        type:     Array,
        observer: '_elementsChanged',
      },

      /**
       * The currently displayed element.
       *
       * @type {!hydrolysis.ElementDescriptor}
       */
      _activeElement: Object,

      /**
       * The hydrolysis analyzer.
       *
       * @type {!hydrolysis.Analyzer}
       */
      _analyzer: {
        observer: '_analyzerChanged',
      },

      /** Whether the analyzer is loading source. */
      _loading: {
        type:     Boolean,
        observer: '_loadingChanged',
      },

    },

    ready: function() {
      var elements = this._loadJson();
      if (!elements) return;
      this._elements = elements;
      this._loading  = false;
    },

    /**
     * Loads a hydrolysis element descriptor (as JSON) from the text content of
     * this element, if present.
     *
     * @return {hydrolysis.ElementDescriptor} The parsed descriptor, or `null`.
     */
    _loadJson: function() {
      var textContent = '';
      Array.prototype.forEach.call(Polymer.dom(this).childNodes, function(node) {
        textContent = textContent + node.textContent;
      });
      textContent = textContent.trim();
      if (textContent === '') return null;

      try {
        return JSON.parse(textContent);
      } catch(error) {
        console.error('Failure when parsing JSON:', textContent, error);
        throw error;
      }
    },

    _elementsChanged: function() {
      this._activeElement = (this._elements || [])[0];
    },

    _loadingChanged: function() {
      this.toggleClass('loaded', !this._loading);
    },

    _analyzerChanged: function() {
      this._elements = this._analyzer ? this._analyzer.elements : [];
    },

    /**
     * Activates the element that the user selected.
     *
     * @param {!Event} event
     */
    _onTapNavItem: function(event) {
      var elementName = event.target.textContent;
      for (var i = 0, element; element = this._elements[i]; i++) {
        if (element.is === elementName) {
          this._activeElement = element;
          return;
        }
      }
    },

    /**
     * Renders this element into static HTML for offline use.
     *
     * This is mostly useful for debugging and one-off documentation generation.
     * If you want to integrate doc generation into your build process, you
     * probably want to be calling `hydrolysis.Analyzer.analyze()` directly.
     *
     * @return {string} The HTML for this element with all state baked in.
     */
    marshal: function() {
      var jsonText = JSON.stringify(this._elements || [], null, '  ');
      return '<' + this.is + '>\n' +
             jsonText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n' +
             '</' + this.is + '>';
    },

  });

})();
</script>
